#!/bin/bash
#===============================================================================
# Post-Commit Hook: ç´¯ç§¯è®°å½•æ¯æ¬¡æäº¤ä¿¡æ¯
# 
# åŠŸèƒ½ï¼šåœ¨æ¯æ¬¡ git commit åï¼Œå°†æäº¤ä¿¡æ¯è¿½åŠ åˆ°ç´¯ç§¯æ–‡ä»¶ä¸­
# ä½ç½®ï¼š.githooks/post-commit
# å®‰è£…ï¼šgit config core.hooksPath .githooks
#===============================================================================

set -e

#-------------------------------------------------------------------------------
# é…ç½®åŒºåŸŸ
#-------------------------------------------------------------------------------
ACCUMULATOR_DIR=".git/commit-accumulator"
LOG_FILE=".git/hooks.log"

# éœ€è¦è·³è¿‡çš„åˆ†æ”¯ï¼ˆä¸è®°å½•è¿™äº›åˆ†æ”¯çš„æäº¤ï¼‰
SKIP_BRANCHES=("main" "master" "develop" "release")

#-------------------------------------------------------------------------------
# å·¥å…·å‡½æ•°
#-------------------------------------------------------------------------------
log() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[$timestamp] [post-commit] $1" >> "$LOG_FILE"
}

is_skip_branch() {
    local branch=$1
    for skip in "${SKIP_BRANCHES[@]}"; do
        if [[ "$branch" == "$skip" ]]; then
            return 0
        fi
    done
    return 1
}

#-------------------------------------------------------------------------------
# ä¸»é€»è¾‘
#-------------------------------------------------------------------------------
main() {
    # è·å–å½“å‰åˆ†æ”¯
    local current_branch=$(git branch --show-current 2>/dev/null)
    
    # å¦‚æœæ— æ³•è·å–åˆ†æ”¯ï¼ˆå¦‚ detached HEADï¼‰ï¼Œè·³è¿‡
    if [[ -z "$current_branch" ]]; then
        log "è·³è¿‡ï¼šæ— æ³•è·å–å½“å‰åˆ†æ”¯ï¼ˆå¯èƒ½æ˜¯ detached HEADï¼‰"
        exit 0
    fi
    
    # æ£€æŸ¥æ˜¯å¦éœ€è¦è·³è¿‡æ­¤åˆ†æ”¯
    if is_skip_branch "$current_branch"; then
        log "è·³è¿‡ï¼šåˆ†æ”¯ '$current_branch' åœ¨è·³è¿‡åˆ—è¡¨ä¸­"
        exit 0
    fi
    
    # ç¡®ä¿ç´¯ç§¯ç›®å½•å­˜åœ¨
    mkdir -p "$ACCUMULATOR_DIR"
    
    # ç´¯ç§¯æ–‡ä»¶è·¯å¾„ï¼ˆä½¿ç”¨åˆ†æ”¯åï¼Œæ›¿æ¢ / ä¸º -ï¼‰
    local safe_branch_name=$(echo "$current_branch" | tr '/' '-')
    local accumulator_file="$ACCUMULATOR_DIR/${safe_branch_name}.json"
    
    # è·å–æäº¤ä¿¡æ¯
    local commit_hash=$(git log -1 --pretty=%H)
    local commit_hash_short=$(git log -1 --pretty=%h)
    local commit_message=$(git log -1 --pretty=%B | head -1)
    local commit_body=$(git log -1 --pretty=%b)
    local commit_author=$(git log -1 --pretty=%an)
    local commit_date=$(git log -1 --pretty=%ci)
    local changed_files=$(git diff-tree --no-commit-id --name-only -r HEAD | tr '\n' ',' | sed 's/,$//')
    local stats=$(git diff-tree --no-commit-id --stat -r HEAD | tail -1)
    
    # è½¬ä¹‰ JSON ç‰¹æ®Šå­—ç¬¦
    local escaped_message=$(echo "$commit_message" | sed 's/\\/\\\\/g; s/"/\\"/g')
    local escaped_stats=$(echo "$stats" | sed 's/\\/\\\\/g; s/"/\\"/g')

    # æ„å»º JSON æ¡ç›®
    local json_entry=$(cat << EOF
{
    "hash": "$commit_hash",
    "hash_short": "$commit_hash_short",
    "message": "$escaped_message",
    "body": $(echo "$commit_body" | jq -Rs . 2>/dev/null || echo '""'),
    "author": "$commit_author",
    "date": "$commit_date",
    "files": "$changed_files",
    "stats": "$escaped_stats"
}
EOF
)
    
    # å¦‚æœç´¯ç§¯æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„ JSON æ•°ç»„
    if [[ ! -f "$accumulator_file" ]]; then
        echo '{
    "branch": "'"$current_branch"'",
    "created_at": "'"$(date -Iseconds)"'",
    "commits": []
}' > "$accumulator_file"
    fi
    
    # ä½¿ç”¨ jq è¿½åŠ æäº¤è®°å½•ï¼ˆå¦‚æœæ²¡æœ‰ jqï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆï¼‰
    if command -v jq &> /dev/null; then
        local temp_file=$(mktemp)
        jq --argjson commit "$json_entry" '.commits += [$commit] | .updated_at = "'"$(date -Iseconds)"'"' "$accumulator_file" > "$temp_file"
        mv "$temp_file" "$accumulator_file"
    else
        # å¤‡ç”¨æ–¹æ¡ˆï¼šç®€å•çš„æ–‡æœ¬è¿½åŠ 
        local text_file="$ACCUMULATOR_DIR/${safe_branch_name}.txt"
        echo "---" >> "$text_file"
        echo "Commit: $commit_hash_short" >> "$text_file"
        echo "Date: $commit_date" >> "$text_file"
        echo "Message: $commit_message" >> "$text_file"
        echo "Files: $changed_files" >> "$text_file"
        echo "" >> "$text_file"
    fi
    
    log "å·²è®°å½•æäº¤ $commit_hash_short åˆ° $accumulator_file"
    echo "ğŸ“ å·²è®°å½•æäº¤ $commit_hash_short"
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
