#!/bin/bash
#===============================================================================
# Pre-Push Hook: æ±‡æ€»ç´¯ç§¯çš„æäº¤å¹¶ç”ŸæˆåŠŸèƒ½æ–‡æ¡£
# 
# åŠŸèƒ½ï¼š
#   1. è¯»å– post-commit ç´¯ç§¯çš„æäº¤è®°å½•
#   2. è°ƒç”¨ Claude Code (headless) ç”ŸæˆåŠŸèƒ½æ–‡æ¡£
#   3. å°†æ–‡æ¡£æäº¤åˆ°ä»“åº“
#   4. æ¸…ç†ç´¯ç§¯æ–‡ä»¶
#
# ä½ç½®ï¼š.githooks/pre-push
# å®‰è£…ï¼šgit config core.hooksPath .githooks
#===============================================================================

set -e

#-------------------------------------------------------------------------------
# é…ç½®åŒºåŸŸ
#-------------------------------------------------------------------------------
ACCUMULATOR_DIR=".git/commit-accumulator"
DOCS_DIR="docs/features"
LOG_FILE=".git/hooks.log"

# éœ€è¦è·³è¿‡çš„åˆ†æ”¯
SKIP_BRANCHES=("main" "master" "develop" "release")

# Claude é…ç½®
CLAUDE_TIMEOUT=120  # ç§’
CLAUDE_MODEL=""     # ç•™ç©ºä½¿ç”¨é»˜è®¤ï¼Œæˆ–è®¾ç½®ä¸º "opus" / "sonnet"

#-------------------------------------------------------------------------------
# å·¥å…·å‡½æ•°
#-------------------------------------------------------------------------------
log() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[$timestamp] [pre-push] $1" >> "$LOG_FILE"
}

is_skip_branch() {
    local branch=$1
    for skip in "${SKIP_BRANCHES[@]}"; do
        if [[ "$branch" == "$skip" ]]; then
            return 0
        fi
    done
    return 1
}

check_claude_available() {
    if ! command -v claude &> /dev/null; then
        echo "âš ï¸  Claude Code CLI æœªå®‰è£…ï¼Œè·³è¿‡æ–‡æ¡£ç”Ÿæˆ"
        log "é”™è¯¯ï¼šClaude Code CLI æœªæ‰¾åˆ°"
        return 1
    fi
    return 0
}

#-------------------------------------------------------------------------------
# æ–‡æ¡£ç”Ÿæˆå‡½æ•°
#-------------------------------------------------------------------------------
generate_documentation() {
    local branch=$1
    local accumulator_file=$2
    local output_file=$3
    
    # è¯»å–ç´¯ç§¯çš„æäº¤ä¿¡æ¯
    local commits_content=""
    
    if command -v jq &> /dev/null && [[ -f "$accumulator_file" ]]; then
        # ä½¿ç”¨ jq è§£æ JSON
        commits_content=$(jq -r '
            "## åˆ†æ”¯ä¿¡æ¯\n- åˆ†æ”¯å: \(.branch)\n- åˆ›å»ºæ—¶é—´: \(.created_at)\n- æ›´æ–°æ—¶é—´: \(.updated_at // "N/A")\n\n## æäº¤è®°å½•\n" +
            ([.commits[] | "### \(.hash_short) - \(.message)\n- æ—¶é—´: \(.date)\n- ä½œè€…: \(.author)\n- æ–‡ä»¶: \(.files)\n- ç»Ÿè®¡: \(.stats)\n"] | join("\n"))
        ' "$accumulator_file" 2>/dev/null)
    else
        # å¤‡ç”¨ï¼šè¯»å–æ–‡æœ¬æ ¼å¼
        local text_file="${accumulator_file%.json}.txt"
        if [[ -f "$text_file" ]]; then
            commits_content=$(cat "$text_file")
        fi
    fi
    
    # å¦‚æœæ²¡æœ‰å†…å®¹ï¼Œè·³è¿‡
    if [[ -z "$commits_content" ]]; then
        log "æ²¡æœ‰ç´¯ç§¯çš„æäº¤å†…å®¹"
        return 1
    fi
    
    # è·å–é¢å¤–ä¸Šä¸‹æ–‡ï¼šä¸»è¦ä¿®æ”¹çš„æ–‡ä»¶å†…å®¹æ‘˜è¦
    local main_files=$(echo "$commits_content" | grep -oP '(?<=æ–‡ä»¶: )[^,]+' | head -5 | tr '\n' ' ')
    
    # æ„å»º Claude æç¤º
    local prompt="ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æŠ€æœ¯æ–‡æ¡£å·¥ç¨‹å¸ˆã€‚è¯·åŸºäºä»¥ä¸‹ Git æäº¤è®°å½•ï¼Œä¸ºè¿™ä¸ªåŠŸèƒ½/ä¿®å¤ç”Ÿæˆä¸€ä»½æ¸…æ™°ã€ä¸“ä¸šçš„æŠ€æœ¯æ–‡æ¡£ã€‚

$commits_content

è¯·ç”Ÿæˆä¸€ä¸ª Markdown æ ¼å¼çš„æ–‡æ¡£ï¼ŒåŒ…å«ä»¥ä¸‹éƒ¨åˆ†ï¼š

# [æ ¹æ®æäº¤å†…å®¹æ¨æ–­çš„åŠŸèƒ½åç§°]

## æ¦‚è¿°
[ç”¨ 2-3 å¥è¯æè¿°è¿™ä¸ªåŠŸèƒ½/ä¿®å¤çš„ç›®çš„å’Œä»·å€¼]

## å˜æ›´æ‘˜è¦
[åˆ—å‡ºä¸»è¦çš„å˜æ›´ç‚¹ï¼Œä½¿ç”¨ bullet points]

## æŠ€æœ¯ç»†èŠ‚
[æè¿°å…³é”®çš„æŠ€æœ¯å®ç°ï¼Œå¦‚æœèƒ½ä»æ–‡ä»¶åæ¨æ–­çš„è¯]

## å½±å“èŒƒå›´
[åˆ—å‡ºå—å½±å“çš„æ¨¡å—æˆ–åŠŸèƒ½åŒºåŸŸ]

## ç›¸å…³æäº¤
[åˆ—å‡ºæ‰€æœ‰æäº¤çš„ç®€çŸ­å“ˆå¸Œå’Œæ¶ˆæ¯]

---
*æ­¤æ–‡æ¡£ç”± Claude Code è‡ªåŠ¨ç”Ÿæˆäº $(date '+%Y-%m-%d %H:%M:%S')*

æ³¨æ„äº‹é¡¹ï¼š
1. ä¿æŒä¸“ä¸šã€ç®€æ´
2. åªè¾“å‡º Markdown å†…å®¹ï¼Œä¸è¦æœ‰ä»»ä½•å‰è¨€æˆ–è§£é‡Š
3. å¦‚æœä¿¡æ¯ä¸è¶³ä»¥æ¨æ–­æŸéƒ¨åˆ†å†…å®¹ï¼Œå¯ä»¥æ ‡æ³¨ [å¾…è¡¥å……]
4. æ–‡æ¡£æ€»é•¿åº¦æ§åˆ¶åœ¨ 300 å­—ä»¥å†…"

    # è°ƒç”¨ Claude Code headless æ¨¡å¼
    log "å¼€å§‹è°ƒç”¨ Claude ç”Ÿæˆæ–‡æ¡£..."
    echo "ğŸ¤– æ­£åœ¨è°ƒç”¨ Claude ç”Ÿæˆæ–‡æ¡£..."
    
    local claude_output
    if [[ -n "$CLAUDE_MODEL" ]]; then
        claude_output=$(timeout "$CLAUDE_TIMEOUT" claude -p "$prompt" --model "$CLAUDE_MODEL" --output-format text 2>&1) || true
    else
        claude_output=$(timeout "$CLAUDE_TIMEOUT" claude -p "$prompt" --output-format text 2>&1) || true
    fi
    
    # æ£€æŸ¥è¾“å‡ºæ˜¯å¦æœ‰æ•ˆ
    if [[ -z "$claude_output" ]] || [[ "$claude_output" == *"error"* ]] || [[ "$claude_output" == *"Error"* ]]; then
        log "Claude è¾“å‡ºå¼‚å¸¸: $claude_output"
        echo "âš ï¸  Claude ç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨åŸºç¡€æ¨¡æ¿"
        
        # ç”ŸæˆåŸºç¡€æ¨¡æ¿ä½œä¸ºå¤‡ç”¨
        claude_output="# åŠŸèƒ½æ–‡æ¡£: $branch

## æ¦‚è¿°
[å¾…è¡¥å…… - Claude ç”Ÿæˆå¤±è´¥]

## æäº¤è®°å½•
$commits_content

---
*æ­¤æ–‡æ¡£éœ€è¦æ‰‹åŠ¨å®Œå–„*"
    fi
    
    # å†™å…¥æ–‡ä»¶
    echo "$claude_output" > "$output_file"
    log "æ–‡æ¡£å·²ç”Ÿæˆ: $output_file"
    
    return 0
}

#-------------------------------------------------------------------------------
# ä¸»é€»è¾‘
#-------------------------------------------------------------------------------
main() {
    log "========== Pre-push hook å¼€å§‹ =========="
    
    # è·å–å½“å‰åˆ†æ”¯
    local current_branch=$(git branch --show-current 2>/dev/null)
    
    if [[ -z "$current_branch" ]]; then
        log "æ— æ³•è·å–å½“å‰åˆ†æ”¯ï¼Œè·³è¿‡"
        exit 0
    fi
    
    log "å½“å‰åˆ†æ”¯: $current_branch"
    
    # æ£€æŸ¥æ˜¯å¦éœ€è¦è·³è¿‡
    if is_skip_branch "$current_branch"; then
        log "è·³è¿‡ï¼šåˆ†æ”¯åœ¨è·³è¿‡åˆ—è¡¨ä¸­"
        echo "ğŸ“Œ è·³è¿‡æ–‡æ¡£ç”Ÿæˆï¼ˆåˆ†æ”¯: $current_branchï¼‰"
        exit 0
    fi
    
    # æ£€æŸ¥ç´¯ç§¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    local safe_branch_name=$(echo "$current_branch" | tr '/' '-')
    local accumulator_file="$ACCUMULATOR_DIR/${safe_branch_name}.json"
    local accumulator_text="$ACCUMULATOR_DIR/${safe_branch_name}.txt"
    
    if [[ ! -f "$accumulator_file" ]] && [[ ! -f "$accumulator_text" ]]; then
        log "æ²¡æœ‰ç´¯ç§¯çš„æäº¤è®°å½•ï¼Œè·³è¿‡æ–‡æ¡£ç”Ÿæˆ"
        echo "ğŸ“Œ æ²¡æœ‰æ–°çš„æäº¤è®°å½•éœ€è¦ç”Ÿæˆæ–‡æ¡£"
        exit 0
    fi
    
    # æ£€æŸ¥ Claude æ˜¯å¦å¯ç”¨
    if ! check_claude_available; then
        exit 0
    fi
    
    # å‡†å¤‡è¾“å‡ºç›®å½•
    mkdir -p "$DOCS_DIR"
    local doc_file="$DOCS_DIR/${safe_branch_name}.md"
    
    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘           ğŸ“ Claude Code æ–‡æ¡£ç”Ÿæˆå™¨                          â•‘"
    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
    echo "â•‘  åˆ†æ”¯: $current_branch"
    echo "â•‘  è¾“å‡º: $doc_file"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    
    # ç”Ÿæˆæ–‡æ¡£
    if generate_documentation "$current_branch" "$accumulator_file" "$doc_file"; then
        echo "âœ… æ–‡æ¡£ç”ŸæˆæˆåŠŸï¼"
        
        # æ£€æŸ¥æ–‡æ¡£æ˜¯å¦æœ‰å®é™…å†…å®¹
        if [[ -s "$doc_file" ]]; then
            # å°†æ–‡æ¡£åŠ å…¥ Git
            git add "$doc_file"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´éœ€è¦æäº¤
            if git diff --cached --quiet "$doc_file" 2>/dev/null; then
                echo "ğŸ“Œ æ–‡æ¡£æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
            else
                # åˆ›å»ºæäº¤
                git commit -m "docs($safe_branch_name): auto-generate feature documentation

- Generated by Claude Code pre-push hook
- Branch: $current_branch
- Date: $(date '+%Y-%m-%d %H:%M:%S')" --no-verify
                
                echo "âœ… æ–‡æ¡£å·²æäº¤åˆ°ä»“åº“"
            fi
        fi
        
        # æ¸…ç†ç´¯ç§¯æ–‡ä»¶
        rm -f "$accumulator_file" "$accumulator_text"
        log "ç´¯ç§¯æ–‡ä»¶å·²æ¸…ç†"
        echo "ğŸ§¹ ç´¯ç§¯è®°å½•å·²æ¸…ç†"
    else
        echo "âš ï¸  æ–‡æ¡£ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼Œç»§ç»­æ¨é€..."
    fi
    
    echo ""
    log "========== Pre-push hook å®Œæˆ =========="
    
    # å§‹ç»ˆå…è®¸æ¨é€ç»§ç»­
    exit 0
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
